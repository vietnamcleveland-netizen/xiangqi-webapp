<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chinese Chess (Xiangqi)</title>
<style>
  :root { --cell:60; }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{background:#f4f4f4;font-family:Arial,Helvetica,sans-serif;text-align:center;color:#222;}
  h1{color:#b22222;margin:16px 0 6px;}
  #turn{color:#666;margin-bottom:12px;font-size:14px;}

  /* bàn cờ cố định tỉ lệ 9:10 */
  #board{
    position:relative;
    width:min(92vw,540px);
    aspect-ratio:9/10;
    margin:0 auto 40px;
    background:#f3c78b;
    border-radius:6px;
    box-shadow:0 4px 10px rgba(0,0,0,.1);
    overflow:hidden;
  }
  svg{
    position:absolute;inset:0;width:100%;height:100%;
    shape-rendering:crispEdges;
  }
  line,rect{stroke:#5e3416;vector-effect:non-scaling-stroke;}
  rect#river{fill:#e4aa5f;}
  text{fill:#5c3717;font-size:28px;font-weight:700;user-select:none;}

  .piece{
    position:absolute;width:50px;height:50px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    background:#fff;font-weight:bold;font-size:22px;cursor:pointer;
    user-select:none;z-index:5;transform:translate(-50%,-50%);
  }
  .red{color:#d32f2f;border:3px solid #d32f2f;}
  .black{color:#000;border:3px solid #000;}
  .hl{
    position:absolute;width:50px;height:50px;border:3px solid #ffd54f;
    border-radius:8px;z-index:4;pointer-events:none;transform:translate(-50%,-50%);
    box-shadow:0 0 8px rgba(0,0,0,.3) inset;
  }
</style>
</head>
<body>
<h1>Chinese Chess (Xiangqi)</h1>
<div id="turn">Red to move</div>

<div id="board">
  <svg viewBox="0 0 540 600" preserveAspectRatio="xMidYMid meet">
    <!-- viền ngoài -->
    <rect x="0.5" y="0.5" width="539" height="599" fill="none" stroke="#5e3416" stroke-width="1"/>

    <!-- ngang -->
    <g stroke-width="1">
      <line x1="0.5" y1="0.5" x2="539.5" y2="0.5"/>
      <line x1="0.5" y1="60.5" x2="539.5" y2="60.5"/>
      <line x1="0.5" y1="120.5" x2="539.5" y2="120.5"/>
      <line x1="0.5" y1="180.5" x2="539.5" y2="180.5"/>
      <line x1="0.5" y1="240.5" x2="539.5" y2="240.5"/>
      <line x1="0.5" y1="300.5" x2="539.5" y2="300.5"/>
      <line x1="0.5" y1="360.5" x2="539.5" y2="360.5"/>
      <line x1="0.5" y1="420.5" x2="539.5" y2="420.5"/>
      <line x1="0.5" y1="480.5" x2="539.5" y2="480.5"/>
      <line x1="0.5" y1="540.5" x2="539.5" y2="540.5"/>
      <line x1="0.5" y1="599.5" x2="539.5" y2="599.5"/>
    </g>

    <!-- dọc -->
    <g stroke-width="1">
      <line x1="0.5" y1="0.5" x2="0.5" y2="599.5"/>
      <line x1="60.5" y1="0.5" x2="60.5" y2="240.5"/><line x1="60.5" y1="360.5" x2="60.5" y2="599.5"/>
      <line x1="120.5" y1="0.5" x2="120.5" y2="240.5"/><line x1="120.5" y1="360.5" x2="120.5" y2="599.5"/>
      <line x1="180.5" y1="0.5" x2="180.5" y2="240.5"/><line x1="180.5" y1="360.5" x2="180.5" y2="599.5"/>
      <line x1="240.5" y1="0.5" x2="240.5" y2="240.5"/><line x1="240.5" y1="360.5" x2="240.5" y2="599.5"/>
      <line x1="300.5" y1="0.5" x2="300.5" y2="240.5"/><line x1="300.5" y1="360.5" x2="300.5" y2="599.5"/>
      <line x1="360.5" y1="0.5" x2="360.5" y2="240.5"/><line x1="360.5" y1="360.5" x2="360.5" y2="599.5"/>
      <line x1="420.5" y1="0.5" x2="420.5" y2="240.5"/><line x1="420.5" y1="360.5" x2="420.5" y2="599.5"/>
      <line x1="480.5" y1="0.5" x2="480.5" y2="240.5"/><line x1="480.5" y1="360.5" x2="480.5" y2="599.5"/>
      <line x1="539.5" y1="0.5" x2="539.5" y2="599.5"/>
    </g>

    <!-- sông -->
    <rect id="river" x="0.5" y="300.5" width="539" height="60"/>
    <text x="210" y="338">楚河</text>
    <text x="310" y="338">漢界</text>

    <!-- chéo cung -->
    <clipPath id="pal-top"><rect x="180.5" y="0.5" width="180" height="120"/></clipPath>
    <clipPath id="pal-bot"><rect x="180.5" y="480.5" width="180" height="120"/></clipPath>
    <g clip-path="url(#pal-top)">
      <line x1="180.5" y1="0.5" x2="360.5" y2="120.5"/>
      <line x1="360.5" y1="0.5" x2="180.5" y2="120.5"/>
    </g>
    <g clip-path="url(#pal-bot)">
      <line x1="180.5" y1="480.5" x2="360.5" y2="600.5"/>
      <line x1="360.5" y1="480.5" x2="180.5" y2="600.5"/>
    </g>
  </svg>
</div>

<script>
(() => {
  const CELL=60, ORI=0.5;
  const board=document.getElementById('board');
  const turnEl=document.getElementById('turn');
  const toPx=(c,r)=>({x:ORI+c*CELL,y:ORI+r*CELL});
  const posKey=(c,r)=>`${c},${r}`;
  let turn='red', selected=null, hl=null;
  const pieces=[], byId=new Map(), pos=new Map();
  const add=(txt,color,c,r)=>{const id=`${txt}_${color}_${c}_${r}`;pieces.push({id,txt,color,c,r});};

  // đen (trên)
  '车马象士将士象马车'.split('').forEach((t,i)=>add(t,'black',i,0));
  add('炮','black',1,2);add('炮','black',7,2);
  [0,2,4,6,8].forEach(c=>add('卒','black',c,3));
  // đỏ (dưới)
  '车马相仕帅仕相马车'.split('').forEach((t,i)=>add(t,'red',i,9));
  add('炮','red',1,7);add('炮','red',7,7);
  [0,2,4,6,8].forEach(c=>add('兵','red',c,6));

  const updateTurn=()=>turnEl.textContent=(turn==='red'?'Red':'Black')+' to move';

  const mount=()=>{
    [...board.querySelectorAll('.piece,.hl')].forEach(n=>n.remove());
    byId.clear();pos.clear();
    pieces.forEach(p=>{
      const el=document.createElement('div');
      el.className=`piece ${p.color}`;
      el.textContent=p.txt;
      const {x,y}=toPx(p.c,p.r);
      el.style.left=`${x}px`;el.style.top=`${y}px`;
      el.dataset.id=p.id;
      el.addEventListener('click',onPiece);
      board.appendChild(el);
      byId.set(p.id,el);
      pos.set(posKey(p.c,p.r),p.id);
    });
  };

  const pieceAt=(c,r)=>{const id=pos.get(posKey(c,r));return id?pieces.find(p=>p.id===id):null;};
  const select=p=>{
    selected=p;
    if(!hl){hl=document.createElement('div');hl.className='hl';board.appendChild(hl);}
    const {x,y}=toPx(p.c,p.r);
    hl.style.left=`${x}px`;hl.style.top=`${y}px`;
  };
  const clearSel=()=>{selected=null;if(hl){hl.remove();hl=null;}};

  const onPiece=e=>{
    const p=pieces.find(x=>x.id===e.currentTarget.dataset.id);
    if(!p)return;
    if(selected && selected.id!==p.id){
      if(selected.color!==p.color){moveTo(selected,p.c,p.r,true);}
      else select(p);return;
    }
    if(p.color!==turn)return;
    select(p);
  };

  board.addEventListener('click',e=>{
    if(e.target.classList.contains('piece'))return;
    if(!selected)return;
    const rect=board.getBoundingClientRect();
    const c=Math.max(0,Math.min(8,Math.round((e.clientX-rect.left-ORI)/CELL)));
    const r=Math.max(0,Math.min(9,Math.round((e.clientY-rect.top-ORI)/CELL)));
    const t=pieceAt(c,r);
    if(t && t.color===selected.color)return;
    moveTo(selected,c,r,!!t);
  });

  const moveTo=(p,c,r,cap=false)=>{
    pos.delete(posKey(p.c,p.r));
    if(cap){
      const v=pieceAt(c,r);
      if(v){
        pieces.splice(pieces.findIndex(x=>x.id===v.id),1);
        byId.get(v.id)?.remove();
        pos.delete(posKey(c,r));
      }
    }
    p.c=c;p.r=r;pos.set(posKey(c,r),p.id);
    const el=byId.get(p.id);const {x,y}=toPx(c,r);
    el.style.left=`${x}px`;el.style.top=`${y}px`;
    turn=turn==='red'?'black':'red';updateTurn();clearSel();
  };

  updateTurn();mount();
})();
</script>
</body>
</html>
